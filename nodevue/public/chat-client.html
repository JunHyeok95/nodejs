<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ChatClient</title>
    <style>
        .red { color:red; }
    </style>
</head>
<body>
    <h1>Chat Client <strong id="myid" class="red"></strong></h1>

    <div id="rooms"></div>

    <hr>

    <div id="status" class="red"></div>

    <div id="list">
        <div>
            <input type="text" id="msg" value="hello Chat">
            <button onclick="send()" id="btnSend">Send</button>
        </div>
    </div>

    <!-- getelementbyid 간단하게 사용하기 위해서 ... -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"></script>

    <!-- socket.io 가 웹 서버랑 연동될 때 기본으로 제공하는 것 -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var square = 'square';
        var joinedRoom = null;
        var socket = io('http://localhost:5000?aaa=111'); // 내가 접속할 서버
        socket.on('connect', function(){
            console.log("connected !!");

            // 자동 로그인 과정
            socket.emit('join', square);
            // 들어올때마다 자기의 방이 있고 square 이라는 방에 들어가라 라는 의미
            joinedRoom = square;

            $('#status').text("Connected : " + joinedRoom);

            // 서버에서 룸을 받아서 처리 해줬다
            socket.emit('rooms', function(rooms){
                console.log("romms >>", rooms);
                $('#rooms').text(rooms);
            });
        });

        // 접속을 하자마자 server 의 message, {msg: 'Welcome ' + socket.id} 가 날아옴
        socket.on('message', function(data){
            console.log("message >>", data);

            let msg = data.msg;
            if (msg && msg.startsWith('Welcome ')){
                // 'Welcome ' + socket.id 의 뒷부분 삭제 
                let myid = msg.substring(msg.lastIndexOf(' ')+1);
                $('#myid').text(myid);
            }
            
        });
        socket.on('disconnect', function(){
            console.log("disconnected ..");
            $('#status').text("disconnected : ");
        });
        function send() {
            // CDN 콘텐츠 전송 네트워크 ... 제이쿼리
            let msg = $('#msg').val();
            socket.emit('message', {room: joinedRoom, msg: msg}, function(ret) {
                // 내가 서버한테 함수가 있다는 것을 알려준다 -> 즉 서버는 파라미터로 함수가 오니까 그걸 실행 할 수 있다.
                // console.log("message.callback >>> ", ret);
            });
        }

    </script>
    
</body>
</html>